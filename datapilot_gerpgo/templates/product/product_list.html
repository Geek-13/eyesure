{% extends 'base/base.html' %}

{% block title %}产品管理 - DataPilot Gerpgo 集成平台{% endblock %}

{% block content_title %}产品列表{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="row">
        <div class="col-md-6">
            <button id="sync-products-btn" class="btn btn-primary">
                <i class="fa fa-refresh mr-1"></i>从Gerpgo同步产品
            </button>
        </div>
        <div class="col-md-6 text-right">
            <div class="input-group" style="width: 300px; margin-left: auto;">
                <input type="text" id="search-input" class="form-control" placeholder="搜索产品名称或SKU">
                <button id="search-btn" class="btn btn-secondary">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered" id="product-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>产品名称</th>
                <th>SKU</th>
                <th>价格</th>
                <th>成本</th>
                <th>分类</th>
                <th>品牌</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="product-table-body">
            <tr>
                <td colspan="9" class="text-center">加载中...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 分页控制 -->
<div class="d-flex justify-content-between mt-4" id="pagination-controls">
    <div class="text-muted">
        显示 <span id="showing-range">0-0</span> 共 <span id="total-count">0</span> 个产品
    </div>
    <div>
        <nav aria-label="Page navigation">
            <ul class="pagination" id="pagination">
                <!-- 分页按钮将由JavaScript动态生成 -->
            </ul>
        </nav>
    </div>
</div>

<!-- 同步产品的模态框 -->
<div class="modal fade" id="sync-modal" tabindex="-1" role="dialog" aria-labelledby="sync-modal-label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sync-modal-label">同步产品数据</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>正在从Gerpgo同步产品数据，请稍候...</p>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="mt-3 text-center" id="sync-status-text">准备同步...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-sync-modal" disabled data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 当前页码
    let currentPage = 1;
    // 每页显示数量
    const pageSize = 10;
    // 搜索关键词
    let searchKeyword = '';
    
    // 加载产品列表
    // 加载产品列表
    function loadProducts(page = 1, keyword = '') {
        const tbody = $('#product-table-body');
        tbody.html('<tr><td colspan="9" class="text-center">加载中...</td></tr>');
        
        // 修改：使用专为前端设计的API路径
        let url = `/api/v1/frontend/products/?page=${page}&pageSize=${pageSize}`;
        if (keyword) {
            url += `&search=${keyword}`;
        }
        
        $.get(url, function(data) {
            tbody.empty();
            
            // 修改：适应get_products_data返回的格式
            if (data.success && data.data.products && data.data.products.length > 0) {
                data.data.products.forEach(function(product) {
                    let statusClass = 'badge-secondary';
                    let statusText = '未知';
                    
                    switch(product.status) {
                        case 'active':
                            statusClass = 'badge-success';
                            statusText = '活跃';
                            break;
                        case 'inactive':
                            statusClass = 'badge-secondary';
                            statusText = '停用';
                            break;
                        case 'draft':
                            statusClass = 'badge-warning';
                            statusText = '草稿';
                            break;
                    }
                    
                    tbody.append(`
                        <tr>
                            <td>${product.id}</td>
                            <td>${product.name}</td>
                            <td>${product.sku}</td>
                            <td>¥${product.price ? product.price.toFixed(2) : '0.00'}</td>
                            <td>¥${product.cost ? product.cost.toFixed(2) : '0.00'}</td>
                            <td>${product.category || '-'}</td>
                            <td>${product.brand || '-'}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>
                                <button class="btn btn-info btn-sm view-product" data-id="${product.id}">
                                    <i class="fa fa-eye"></i> 查看
                                </button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                tbody.append('<tr><td colspan="9" class="text-center">暂无数据</td></tr>');
            }
            
            // 更新分页信息
            updatePagination(data.data.total, page, keyword);
        }).fail(function() {
            tbody.html('<tr><td colspan="9" class="text-center text-danger">加载失败，请重试</td></tr>');
        });
    }
    
    // 更新分页控件
    function updatePagination(totalCount, currentPage, keyword) {
        const totalPages = Math.ceil(totalCount / pageSize);
        const pagination = $('#pagination');
        
        // 更新显示范围
        const start = (currentPage - 1) * pageSize + 1;
        const end = Math.min(currentPage * pageSize, totalCount);
        $('#showing-range').text(`${start}-${end}`);
        $('#total-count').text(totalCount);
        
        // 清空现有分页按钮
        pagination.empty();
        
        // 添加上一页按钮
        const prevClass = currentPage === 1 ? 'disabled' : '';
        pagination.append(`
            <li class="page-item ${prevClass}">
                <a class="page-link" href="#" data-page="${currentPage - 1}" data-keyword="${keyword}">上一页</a>
            </li>
        `);
        
        // 添加页码按钮
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const activeClass = i === currentPage ? 'active' : '';
            pagination.append(`
                <li class="page-item ${activeClass}">
                    <a class="page-link" href="#" data-page="${i}" data-keyword="${keyword}">${i}</a>
                </li>
            `);
        }
        
        // 添加下一页按钮
        const nextClass = currentPage === totalPages ? 'disabled' : '';
        pagination.append(`
            <li class="page-item ${nextClass}">
                <a class="page-link" href="#" data-page="${currentPage + 1}" data-keyword="${keyword}">下一页</a>
            </li>
        `);
    }
    
    // 同步产品数据
    function syncProducts() {
        const modal = new bootstrap.Modal($('#sync-modal'));
        modal.show();
        
        const progressBar = $('.progress-bar');
        const statusText = $('#sync-status-text');
        
        progressBar.css('width', '0%');
        statusText.text('开始同步...');
        
        $.post('/api/v1/sync/products/', {}, function(data) {
            // 轮询同步状态
            const checkSyncStatus = setInterval(function() {
                $.get('/api/v1/sync/logs/?sync_type=products&ordering=-created_at&limit=1', function(logData) {
                    if (logData.results && logData.results.length > 0) {
                        const latestLog = logData.results[0];
                        
                        // 更新进度（这里简化处理，实际应该根据同步的产品数量计算）
                        if (latestLog.status === 'success') {
                            progressBar.css('width', '100%');
                            statusText.text('同步完成！');
                            clearInterval(checkSyncStatus);
                            
                            // 启用关闭按钮
                            $('#close-sync-modal').prop('disabled', false);
                            
                            // 重新加载产品列表
                            loadProducts(currentPage, searchKeyword);
                        } else if (latestLog.status === 'failed') {
                            progressBar.css('width', '100%');
                            progressBar.removeClass('bg-primary').addClass('bg-danger');
                            statusText.text('同步失败！请重试');
                            clearInterval(checkSyncStatus);
                            
                            // 启用关闭按钮
                            $('#close-sync-modal').prop('disabled', false);
                        } else {
                            // 假设正在进行中，更新进度
                            const progress = Math.min(95, Math.floor(Math.random() * 90) + 10);
                            progressBar.css('width', `${progress}%`);
                            statusText.text(`正在同步... ${progress}%`);
                        }
                    }
                }).fail(function() {
                    clearInterval(checkSyncStatus);
                    statusText.text('检查同步状态失败');
                    $('#close-sync-modal').prop('disabled', false);
                });
            }, 2000);
        }).fail(function() {
            progressBar.css('width', '100%');
            progressBar.removeClass('bg-primary').addClass('bg-danger');
            statusText.text('同步请求失败！请重试');
            $('#close-sync-modal').prop('disabled', false);
        });
    }
    
    // 初始化页面
    $(document).ready(function() {
        // 加载产品列表
        loadProducts();
        
        // 搜索按钮点击事件
        $('#search-btn').click(function() {
            searchKeyword = $('#search-input').val().trim();
            loadProducts(1, searchKeyword);
        });
        
        // 回车键搜索
        $('#search-input').keypress(function(e) {
            if (e.which === 13) {
                searchKeyword = $(this).val().trim();
                loadProducts(1, searchKeyword);
            }
        });
        
        // 分页按钮点击事件
        $(document).on('click', '#pagination a', function(e) {
            e.preventDefault();
            const page = parseInt($(this).data('page'));
            const keyword = $(this).data('keyword');
            
            if (!isNaN(page) && page > 0) {
                currentPage = page;
                searchKeyword = keyword;
                loadProducts(currentPage, searchKeyword);
            }
        });
        
        // 同步产品按钮点击事件
        $('#sync-products-btn').click(function() {
            syncProducts();
        });
        
        // 查看产品详情按钮点击事件
        $(document).on('click', '.view-product', function() {
            const productId = $(this).data('id');
            // 这里可以实现产品详情弹窗或跳转到详情页
            alert(`查看产品ID: ${productId} 的详情`);
        });
    });
</script>
{% endblock %}