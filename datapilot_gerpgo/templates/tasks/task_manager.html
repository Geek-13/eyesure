{% extends 'base/base.html' %}
{% load static %}

{% block title %}定时任务管理{% endblock %}

{% block content_title %}<h1>定时任务管理</h1>{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 左侧任务列表区域 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">任务列表</h5>
                    <div>
                        <button id="createTaskBtn" class="btn btn-light btn-sm">
                            <i class="bi bi-plus-circle"></i> 创建任务
                        </button>
                        <button id="refreshTasksBtn" class="btn btn-light btn-sm ml-2">
                            <i class="bi bi-arrow-clockwise"></i> 刷新
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="tasksTable" class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>任务名称</th>
                                    <th>执行函数</th>
                                    <th>Cron表达式</th>
                                    <th>状态</th>
                                    <th>上次执行</th>
                                    <th>下次执行</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody">
                                <!-- 任务数据将通过JS动态加载 -->
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧任务详情/日志区域 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">执行日志</h5>
                </div>
                <div class="card-body">
                    <div id="taskDetailPanel" class="mb-4">
                        <div class="text-center">
                            <p>请选择一个任务查看详情和执行日志</p>
                        </div>
                    </div>
                    <div id="logsContainer" class="overflow-auto" style="max-height: 400px;">
                        <!-- 日志将通过JS动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 创建/编辑任务模态框 -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="taskModalLabel">创建任务</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="taskId" name="id">
                    
                    <div class="mb-3">
                        <label for="taskName" class="form-label">任务名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="taskName" name="name" required placeholder="请输入任务名称">
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">任务描述</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="2" placeholder="请输入任务描述"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskFunction" class="form-label">执行函数 <span class="text-danger">*</span></label>
                        <select class="form-control" id="taskFunction" name="function_path" required>
                            <option value="" disabled selected>请选择同步函数</option>
                            {% for option in task_options %}
                                <option value="{{ option.value }}">{{ option.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskCronExpression" class="form-label">Cron表达式 <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="taskCronExpression" name="cron_expression" required placeholder="请输入Cron表达式">
                            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#cronHelpModal">帮助</button>
                        </div>
                        <div class="form-text">例如：0 0 * * * 表示每天午夜执行</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskParams" class="form-label">执行参数 (JSON格式)</label>
                        
                        <!-- 相对时间选择 -->
                        <div class="mb-2">
                            <label class="form-label">相对时间选择（可选）</label>
                            <div class="btn-group btn-group-sm" role="group" aria-label="相对时间选项">
                                <button type="button" class="btn btn-outline-primary" onclick="setRelativeTime(7)">近7天</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setRelativeTime(14)">近14天</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setRelativeTime(30)">近30天</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setRelativeTime(90)">近90天</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setRelativeTime(180)">近半年</button>
                                <button type="button" class="btn btn-outline-primary" onclick="setRelativeTime(365)">近一年</button>
                            </div>
                        </div>
                        
                        <textarea class="form-control" id="taskParams" name="params" rows="3" placeholder="{\"param1\": \"value1\", \"param2\": value2}"></textarea>
                        <div class="form-text">选填，根据选择的函数确定需要的参数</div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="taskEnabled" name="enabled" checked>
                        <label class="form-check-label" for="taskEnabled">启用任务</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" id="saveTaskBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Cron表达式帮助模态框 -->
<div class="modal fade" id="cronHelpModal" tabindex="-1" aria-labelledby="cronHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="cronHelpModalLabel">Cron表达式说明</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>Cron表达式格式：</h6>
                    <p>秒 分 时 日 月 周 [年]</p>
                    <p>注意：在APScheduler中，前6位必填，年可选</p>
                </div>
                
                <div class="mb-4">
                    <h6>字段含义：</h6>
                    <ul>
                        <li>秒 (0-59)</li>
                        <li>分 (0-59)</li>
                        <li>时 (0-23)</li>
                        <li>日 (1-31)</li>
                        <li>月 (1-12 或 JAN-DEC)</li>
                        <li>周 (0-6 或 SUN-SAT，0和7都代表周日)</li>
                        <li>年 (可选，四位数)</li>
                    </ul>
                </div>
                
                <div class="mb-4">
                    <h6>常用符号：</h6>
                    <ul>
                        <li><code>*</code> 表示所有值</li>
                        <li><code>,</code> 表示枚举值，如 "0,15,30,45" 表示每15分钟</li>
                        <li><code>-</code> 表示范围，如 "10-12" 表示10到12点</li>
                        <li><code>/</code> 表示步长，如 "*/5" 表示每5个单位</li>
                        <li><code>?</code> 只能用在 日 或 周 字段，表示无特定值</li>
                        <li><code>L</code> 只能用在 日 或 周 字段，表示最后一天或最后一个指定星期几</li>
                        <li><code>W</code> 只能用在 日 字段，表示最近的工作日</li>
                    </ul>
                </div>
                
                <div>
                    <h6>示例：</h6>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>表达式</th>
                                <th>含义</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>0 0 * * *</td>
                                <td>每天午夜执行</td>
                            </tr>
                            <tr>
                                <td>0 0 8 * *</td>
                                <td>每天早上8点执行</td>
                            </tr>
                            <tr>
                                <td>0 */30 * * *</td>
                                <td>每30分钟执行一次</td>
                            </tr>
                            <tr>
                                <td>0 0 8 * * 1-5</td>
                                <td>工作日（周一至周五）早上8点执行</td>
                            </tr>
                            <tr>
                                <td>0 0 1 * *</td>
                                <td>每月1号凌晨1点执行</td>
                            </tr>
                            <tr>
                                <td>0 0 0 L * ?</td>
                                <td>每月最后一天午夜执行</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 确认对话框 -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="confirmModalLabel">确认操作</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">确定要执行此操作吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" id="confirmActionBtn" class="btn btn-danger">确认</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 全局变量
    let currentTaskId = null;
    let confirmAction = null;
    
    // DOM 加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化加载任务列表
        loadTasks();
        
        // 绑定刷新按钮事件
        document.getElementById('refreshTasksBtn').addEventListener('click', loadTasks);
        
        // 绑定创建任务按钮事件
        document.getElementById('createTaskBtn').addEventListener('click', function() {
            currentTaskId = null;
            document.getElementById('taskModalLabel').textContent = '创建任务';
            document.getElementById('taskForm').reset();
            document.getElementById('taskEnabled').checked = true;
            $('#taskModal').modal('show');
        });
        
        // 绑定保存任务按钮事件
        document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
        
        // 绑定确认操作按钮事件
        document.getElementById('confirmActionBtn').addEventListener('click', function() {
            if (confirmAction) {
                confirmAction();
                confirmAction = null;
            }
            $('#confirmModal').modal('hide');
        });
    });
    
    // 加载任务列表
    function loadTasks() {
        const tableBody = document.getElementById('tasksTableBody');
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></td></tr>';
        
        fetch('/api/v1/tasks/')
            .then(response => {
                console.log('API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error('网络响应错误: ' + response.status);
                }
                return response.json().catch(err => {
                    console.error('JSON解析错误:', err);
                    // 尝试获取原始文本以检查
                    return response.text().then(text => {
                        console.log('原始响应文本:', text.substring(0, 500) + '...');
                        throw new Error('无法解析JSON响应: ' + text.substring(0, 200));
                    });
                });
            })
            .then(data => {
                console.log('解析后的数据类型:', typeof data);
                console.log('解析后的数据结构:', JSON.stringify(data).substring(0, 500) + '...');
                tableBody.innerHTML = '';
                
                // 支持多种API响应格式
                let tasksArray = [];
                
                try {
                    // 检查是否为Django REST framework默认的分页格式
                    if (data && data.results && Array.isArray(data.results)) {
                        tasksArray = data.results;
                        console.log('使用DRF分页格式 data.results');
                    }
                    // 检查是否有tasks字段
                    else if (data && data.tasks && Array.isArray(data.tasks)) {
                        tasksArray = data.tasks;
                        console.log('使用自定义tasks字段');
                    }
                    // 检查是否本身就是数组
                    else if (Array.isArray(data)) {
                        tasksArray = data;
                        console.log('数据本身是数组');
                    }
                    // 检查是否是单个任务对象
                    else if (data && typeof data === 'object' && data.id) {
                        tasksArray = [data];
                        console.log('单个任务对象，转换为数组');
                    } else {
                        console.warn('未知的数据格式，无法提取任务列表');
                        tasksArray = [];
                    }
                    
                    console.log('最终任务数组长度:', tasksArray.length);
                    
                    if (tasksArray.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">暂无任务数据</td></tr>';
                        return;
                    }
                    
                    // 使用安全的循环方式
                    for (let i = 0; i < tasksArray.length; i++) {
                        const task = tasksArray[i];
                        if (!task || typeof task !== 'object') continue;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${task.id || '-'}</td>
                            <td>${task.name || '未命名'}</td>
                            <td>${task.function_path || '-'}</td>
                            <td>${task.cron_expression || '-'}</td>
                            <td>
                                <span class="badge ${task.status === 'ACTIVE' || task.enabled ? 'bg-success' : 'bg-secondary'}">
                                    ${task.status === 'ACTIVE' || task.enabled ? '启用' : '禁用'}
                                </span>
                            </td>
                            <td>${task.last_run_at || '-'}</td>
                            <td>${task.next_run_at || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary view-task" data-id="${task.id}">查看</button>
                                <button class="btn btn-sm btn-outline-warning edit-task" data-id="${task.id}">编辑</button>
                                <button class="btn btn-sm btn-outline-info toggle-task" data-id="${task.id}" data-enabled="${task.status === 'ACTIVE' || task.enabled}">
                                    ${task.status === 'ACTIVE' || task.enabled ? '暂停' : '启用'}
                                </button>
                                <button class="btn btn-sm btn-outline-success run-task" data-id="${task.id}">立即执行</button>
                                <button class="btn btn-sm btn-outline-danger delete-task" data-id="${task.id}">删除</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    }
                    
                    // 绑定行内按钮事件
                    document.querySelectorAll('.view-task').forEach(btn => {
                        btn.addEventListener('click', function() {
                            viewTask(this.dataset.id);
                        });
                    });
                    
                    document.querySelectorAll('.edit-task').forEach(btn => {
                        btn.addEventListener('click', function() {
                            editTask(this.dataset.id);
                        });
                    });
                    
                    document.querySelectorAll('.toggle-task').forEach(btn => {
                        btn.addEventListener('click', function() {
                            toggleTaskStatus(this.dataset.id, this.dataset.enabled === 'true');
                        });
                    });
                    
                    document.querySelectorAll('.run-task').forEach(btn => {
                        btn.addEventListener('click', function() {
                            runTask(this.dataset.id);
                        });
                    });
                    
                    document.querySelectorAll('.delete-task').forEach(btn => {
                        btn.addEventListener('click', function() {
                            deleteTask(this.dataset.id);
                        });
                    });
                } catch (processingError) {
                    console.error('处理任务数据时出错:', processingError);
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">数据处理错误，请联系管理员</td></tr>';
                }
            })
            .catch(error => {
                console.error('加载任务失败:', error);
                console.error('错误详情:', error.stack || error.message);
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载任务失败，请重试</td></tr>';
            });
    }
    
    // 查看任务详情
    function viewTask(taskId) {
        currentTaskId = taskId;
        const detailPanel = document.getElementById('taskDetailPanel');
        const logsContainer = document.getElementById('logsContainer');
        
        detailPanel.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div>';
        logsContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div>';
        
        // 加载任务详情
        fetch(`/api/v1/tasks/${taskId}/`)
            .then(response => {
                if (!response.ok) throw new Error('任务详情加载失败');
                return response.json();
            })
            .then(task => {
                detailPanel.innerHTML = `
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">任务详情</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>ID:</strong> ${task.id}</p>
                            <p><strong>名称:</strong> ${task.name}</p>
                            <p><strong>描述:</strong> ${task.description || '-'}</p>
                            <p><strong>执行函数:</strong> ${task.task_function || '-'}</p>
                            <p><strong>Cron表达式:</strong> ${task.cron_expression}</p>
                            <p><strong>参数:</strong> ${task.params ? JSON.stringify(task.params) : '-'}</p>
                            <p><strong>状态:</strong> <span class="badge ${task.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">${task.status === 'ACTIVE' ? '启用' : '禁用'}</span></p>
                            <p><strong>创建时间:</strong> ${task.created_at}</p>
                            <p><strong>更新时间:</strong> ${task.updated_at}</p>
                            <p><strong>上次执行:</strong> ${task.last_executed || '-'}</p>
                        </div>
                    </div>
                `;
                
                // 加载任务执行日志
                loadTaskLogs(taskId);
            })
            .catch(error => {
                console.error('加载任务详情失败:', error);
                detailPanel.innerHTML = '<div class="text-center text-danger">加载任务详情失败</div>';
            });
    }
    
    // 加载任务执行日志
    function loadTaskLogs(taskId) {
        const logsContainer = document.getElementById('logsContainer');
        
        fetch(`/api/v1/task-logs/?task_id=${taskId}`)
            .then(response => {
                if (!response.ok) throw new Error('日志加载失败');
                return response.json();
            })
            .then(logs => {
                if (logs.length === 0) {
                    logsContainer.innerHTML = '<div class="text-center text-muted">暂无执行日志</div>';
                    return;
                }
                
                logsContainer.innerHTML = '';
                logs.slice(0, 20).forEach(log => { // 只显示最近20条日志
                    const logItem = document.createElement('div');
                    logItem.className = `card mb-2 ${log.status === 'success' ? 'border-success' : log.status === 'failed' ? 'border-danger' : ''}`;
                    logItem.innerHTML = `
                        <div class="card-header ${log.status === 'success' ? 'bg-success' : log.status === 'failed' ? 'bg-danger' : 'bg-secondary'} text-white">
                            <div class="d-flex justify-content-between">
                                <span>${log.start_time}</span>
                                <span class="badge bg-white text-${log.status === 'success' ? 'success' : log.status === 'failed' ? 'danger' : 'secondary'}">
                                    ${log.status === 'success' ? '成功' : log.status === 'failed' ? '失败' : '进行中'}
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <p><strong>耗时:</strong> ${log.duration || '-'}</p>
                            ${log.message ? `<div class="mt-2"><strong>执行结果:</strong><pre class="mt-1 p-2 bg-light rounded">${log.message}</pre></div>` : ''}
                            ${log.error ? `<div class="mt-2"><strong>错误信息:</strong><pre class="mt-1 p-2 bg-danger bg-opacity-10 rounded text-danger">${log.error}</pre></div>` : ''}
                        </div>
                    `;
                    logsContainer.appendChild(logItem);
                });
            })
            .catch(error => {
                console.error('加载日志失败:', error);
                logsContainer.innerHTML = '<div class="text-center text-danger">加载日志失败</div>';
            });
    }
    
    // 编辑任务
    function editTask(taskId) {
        currentTaskId = taskId;
        document.getElementById('taskModalLabel').textContent = '编辑任务';
        
        fetch(`/api/v1/tasks/${taskId}/`)
            .then(response => {
                if (!response.ok) throw new Error('任务加载失败');
                return response.json();
            })
            .then(task => {
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskFunction').value = task.function_path;
                document.getElementById('taskCronExpression').value = task.cron_expression;
                document.getElementById('taskParams').value = task.params ? JSON.stringify(task.params) : '';
                document.getElementById('taskEnabled').checked = task.enabled;
                
                $('#taskModal').modal('show');
            })
            .catch(error => {
                console.error('加载任务失败:', error);
                showToast('加载任务失败', 'error');
            });
    }
    
    // 保存任务 - VERSION 2.0 - 完全重写以避免缓存问题
    function saveTask(event) {
        // 防止表单默认提交
        if (event) event.preventDefault();
        
        console.log('========= SAVE TASK FUNCTION V2.0 CALLED =========');
        console.log('调用堆栈:', new Error().stack);
        console.log('当前时间戳:', new Date().toISOString());
        
        // 完全绕过FormData，直接从表单元素获取值
        const name = document.getElementById('taskName').value;
        const functionPath = document.getElementById('taskFunction').value;
        const cronExpression = document.getElementById('taskCronExpression').value;
        const enabled = document.getElementById('taskEnabled').checked;
        const params = document.getElementById('taskParams').value;
        
        // 详细调试 - 记录表单数据
        console.log('1. 直接从表单元素获取的值:', {
            name: name,
            functionPath: functionPath,
            cronExpression: cronExpression,
            enabled: enabled,
            params: params
        });
        
        // 处理参数字段
        let paramsDict = {};
        if (params && params.trim()) {
            try {
                paramsDict = JSON.parse(params);
                console.log('2. 解析后的参数字段:', paramsDict);
            } catch (e) {
                console.error('参数JSON解析错误:', e, '输入值:', params);
                showToast('参数格式错误，请输入有效的JSON格式', 'error');
                return;
            }
        }
        
        // 仅创建后端需要的字段的新对象
        // 注意：这里只包含5个必要字段，没有其他多余字段
        const backendData = {
            name: name,
            task_function: functionPath, // 这是后端需要的字段名
            cron_expression: cronExpression,
            status: enabled ? 'ACTIVE' : 'INACTIVE', // 这是后端需要的字段名
            params_dict: paramsDict
        };
        
        // 验证对象结构
        console.log('3. 构建的后端数据对象键:', Object.keys(backendData));
        console.log('3. 构建的后端数据对象:', backendData);
        
        // 手动构建JSON字符串
        const jsonBody = JSON.stringify(backendData);
        console.log('4. 发送的JSON字符串:', jsonBody);
        console.log('4. JSON字符串长度:', jsonBody.length);
        
        // 构建完整URL
        const baseUrl = `http://${window.location.host}`;
        const url = currentTaskId 
            ? `${baseUrl}/api/v1/tasks/${currentTaskId}/` 
            : `${baseUrl}/api/v1/tasks/`;
        const method = currentTaskId ? 'PUT' : 'POST';
        
        console.log('5. 请求URL:', url);
        console.log('5. 请求方法:', method);
        
        // 构建请求选项
        const requestOptions = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-Debug-Version': '2.0',
                'X-Debug-Time': new Date().getTime().toString()
            },
            body: jsonBody
        };
        
        console.log('6. 请求头:', requestOptions.headers);
        
        // 使用fetch发送请求
        console.log('7. 开始发送请求...');
        fetch(url, requestOptions)
            .then(response => {
                console.log('8. 收到响应，状态码:', response.status);
                console.log('8. 响应头:', Object.fromEntries(response.headers));
                
                // 先读取原始响应文本
                return response.text().then(text => {
                    console.log('9. 原始响应内容:', text);
                    
                    try {
                        // 尝试解析JSON
                        const data = text ? JSON.parse(text) : {};
                        
                        if (!response.ok) {
                            console.error('10. 错误响应数据:', data);
                            // 提取错误信息
                            let errorMessage = '保存失败';
                            if (typeof data === 'object' && data !== null) {
                                if (data.detail) errorMessage = data.detail;
                                else if (data.error) errorMessage = data.error;
                                else if (Object.keys(data).length > 0) {
                                    errorMessage = Object.entries(data)
                                        .map(([field, errors]) => `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`)
                                        .join('; ');
                                }
                            } else if (text.trim()) {
                                errorMessage = text.trim();
                            }
                            throw new Error(errorMessage);
                        }
                        return data;
                    } catch (jsonError) {
                        console.error('11. JSON解析错误:', jsonError);
                        throw new Error(`保存失败: 服务器返回无效JSON (状态码: ${response.status})\n原始响应: ${text.substring(0, 200)}...`);
                    }
                });
            })
            .then(data => {
                console.log('12. 请求成功，返回数据:', data);
                $('#taskModal').modal('hide');
                loadTasks();
                showToast(currentTaskId ? '任务更新成功' : '任务创建成功', 'success');
            })
            .catch(error => {
                console.error('13. 保存任务失败:', error);
                // 显示详细错误信息
                showToast(`保存失败: ${error.message}`, 'error');
                // 添加详细错误信息到控制台
                console.group('任务保存失败详细信息:');
                console.error('错误类型:', error.name);
                console.error('错误信息:', error.message);
                console.error('请求URL:', url);
                console.error('请求方法:', method);
                console.error('发送的数据:', backendData);
                console.error('JSON字符串:', jsonBody);
                console.groupEnd();
            });
        
        console.log('========= SAVE TASK FUNCTION V2.0 EXECUTION COMPLETE =========');
    }
    
    // 切换任务状态
    function toggleTaskStatus(taskId, isEnabled) {
        document.getElementById('confirmMessage').textContent = `确定要${isEnabled ? '暂停' : '启用'}该任务吗？`;
        confirmAction = function() {
            const requestOptions = {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                // 修改为后端期望的字段名和值格式
                body: JSON.stringify({ status: !isEnabled ? 'ACTIVE' : 'INACTIVE' }),
            };
            
            fetch(`/api/v1/tasks/${taskId}/`, requestOptions)
                .then(response => {
                    if (!response.ok) throw new Error('操作失败');
                    return response.json();
                })
                .then(() => {
                    loadTasks();
                    showToast(`任务已${isEnabled ? '暂停' : '启用'}`, 'success');
                    // 如果当前正在查看该任务，刷新详情
                    if (currentTaskId === taskId) {
                        viewTask(taskId);
                    }
                })
                .catch(error => {
                    console.error('切换任务状态失败:', error);
                    showToast('操作失败', 'error');
                });
        };
        
        $('#confirmModal').modal('show');
    }
    
    // 立即执行任务
    function runTask(taskId) {
        document.getElementById('confirmMessage').textContent = '确定要立即执行该任务吗？';
        confirmAction = function() {
            fetch(`/api/v1/tasks/${taskId}/execute-now/`, { method: 'POST' })
                .then(response => {
                    if (!response.ok) throw new Error('执行失败');
                    return response.json();
                })
                .then(() => {
                    showToast('任务已开始执行', 'success');
                    // 刷新日志
                    if (currentTaskId === taskId) {
                        setTimeout(() => loadTaskLogs(taskId), 1000);
                    }
                })
                .catch(error => {
                    console.error('执行任务失败:', error);
                    showToast('执行失败', 'error');
                });
        };
        
        $('#confirmModal').modal('show');
    }
    
    // 删除任务
    function deleteTask(taskId) {
        document.getElementById('confirmMessage').textContent = '确定要删除该任务吗？此操作不可撤销。';
        confirmAction = function() {
            fetch(`/api/v1/tasks/${taskId}/`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) throw new Error('删除失败');
                    return response.json();
                })
                .then(() => {
                    loadTasks();
                    showToast('任务已删除', 'success');
                    // 如果当前正在查看该任务，清空详情
                    if (currentTaskId === taskId) {
                        currentTaskId = null;
                        document.getElementById('taskDetailPanel').innerHTML = '<div class="text-center"><p>请选择一个任务查看详情和执行日志</p></div>';
                        document.getElementById('logsContainer').innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('删除任务失败:', error);
                    showToast('删除失败', 'error');
                });
        };
        
        $('#confirmModal').modal('show');
    }
    
    // 设置相对时间参数
    function setRelativeTime(days) {
        const paramsTextarea = document.getElementById('taskParams');
        let params = {};
        
        // 尝试解析现有的参数字符串
        if (paramsTextarea.value.trim()) {
            try {
                params = JSON.parse(paramsTextarea.value);
                // 确保params是对象
                if (typeof params !== 'object' || params === null || Array.isArray(params)) {
                    params = {};
                }
            } catch (e) {
                // 如果解析失败，创建新的参数字对象
                params = {};
            }
        }
        
        // 添加或更新相对天数参数
        params.relative_days = days;
        
        // 移除可能存在的具体日期参数
        delete params.startDate;
        delete params.endDate;
        delete params.start_date;
        delete params.end_date;
        
        // 格式化JSON字符串为紧凑格式，避免缩进导致的问题
        paramsTextarea.value = JSON.stringify(params);
        
        showToast(`已设置相对时间为近${days}天`, 'success');
    }
    
    // 显示提示消息
    function showToast(message, type = 'info') {
        // 创建toast元素
        const toastContainer = document.createElement('div');
        toastContainer.className = `toast fade ${type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info'} text-white`;
        toastContainer.role = 'alert';
        toastContainer.setAttribute('aria-live', 'assertive');
        toastContainer.setAttribute('aria-atomic', 'true');
        
        toastContainer.innerHTML = `
            <div class="toast-body">
                ${message}
            </div>
        `;
        
        // 添加到body并显示
        document.body.appendChild(toastContainer);
        const toast = new bootstrap.Toast(toastContainer);
        toast.show();
        
        // 自动移除
        setTimeout(() => {
            toast.hide();
            setTimeout(() => {
                document.body.removeChild(toastContainer);
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}